Path: news.gmane.org!not-for-mail
From: Felipe Balbi <balbi@ti.com>
Newsgroups: gmane.linux.kernel,gmane.linux.ports.arm.omap
Subject: Re: [GPIO] Crashed when not using
Date: Tue, 31 Jul 2012 09:43:51 +0300
Lines: 92
Approved: news@gmane.org
Message-ID: <20120731064350.GD6004@arwen.pp.htv.fi>
References: <CAKdam54gXixs4F-a07ajj9GNMth46d4NTdoUL3GokzvjuWaGyg@mail.gmail.com>
 <CAC83ZvKnOw+UBOWYtt294k-5Xk8S6Gy1pChSF7aXGmGjLGSeCA@mail.gmail.com>
 <CAKdam56QEXY55SYC7YND4BP=tQmiyAa=avVCADTj3Ym6X9cCvg@mail.gmail.com>
 <87fw89gf4w.fsf@ti.com>
Reply-To: balbi@ti.com
NNTP-Posting-Host: plane.gmane.org
Mime-Version: 1.0
Content-Type: multipart/signed; micalg=pgp-sha1;
	protocol="application/pgp-signature"; boundary="d9ADC0YsG2v16Js0"
X-Trace: dough.gmane.org 1343717248 2662 80.91.229.3 (31 Jul 2012 06:47:28 GMT)
X-Complaints-To: usenet@dough.gmane.org
NNTP-Posting-Date: Tue, 31 Jul 2012 06:47:28 +0000 (UTC)
Cc: "Poddar, Sourav" <sourav.poddar@ti.com>,
	"DebBarma, Tarun Kanti" <tarun.kanti@ti.com>,
	lo <linux-omap@vger.kernel.org>,
	Santosh Shilimkar <santosh.shilimkar@ti.com>,
	Benoit Cousson <b-cousson@ti.com>,
	linux-kernel@vger.kernel.org, Felipe Balbi <balbi@ti.com>
To: Kevin Hilman <khilman@ti.com>
Original-X-From: linux-kernel-owner@vger.kernel.org Tue Jul 31 08:47:27 2012
Return-path: <linux-kernel-owner@vger.kernel.org>
Envelope-to: glk-linux-kernel-3@plane.gmane.org
Original-Received: from vger.kernel.org ([209.132.180.67])
	by plane.gmane.org with esmtp (Exim 4.69)
	(envelope-from <linux-kernel-owner@vger.kernel.org>)
	id 1Sw6El-0005HE-W8
	for glk-linux-kernel-3@plane.gmane.org; Tue, 31 Jul 2012 08:47:24 +0200
Original-Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1755535Ab2GaGrQ (ORCPT <rfc822;glk-linux-kernel-3@m.gmane.org>);
	Tue, 31 Jul 2012 02:47:16 -0400
Original-Received: from na3sys009aog138.obsmtp.com ([74.125.149.19]:33190 "EHLO
	na3sys009aog138.obsmtp.com" rhost-flags-OK-OK-OK-OK)
	by vger.kernel.org with ESMTP id S1755505Ab2GaGrO (ORCPT
	<rfc822;linux-kernel@vger.kernel.org>);
	Tue, 31 Jul 2012 02:47:14 -0400
Original-Received: from mail-lpp01m010-f46.google.com ([209.85.215.46]) (using TLSv1) by na3sys009aob138.postini.com ([74.125.148.12]) with SMTP
	ID DSNKUBd/cXih65wEjYDENrRB+bLQrXCjiPQE@postini.com; Mon, 30 Jul 2012 23:47:13 PDT
Original-Received: by lahd3 with SMTP id d3so4244622lah.33
        for <linux-kernel@vger.kernel.org>; Mon, 30 Jul 2012 23:47:11 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20120113;
        h=date:from:to:cc:subject:message-id:reply-to:references:mime-version
         :content-type:content-disposition:in-reply-to:user-agent
         :x-gm-message-state;
        bh=J0/4YqW3RwUtNoItN/Jp2HWGKpTGEs+E/t+rmJyaU4Q=;
        b=F3ODFCP/nBeIFy8OJtEGtKY1kOYalpB9s38qjG6A12y3B0dSIjMMWpg0E+0NhpMl3k
         RdfOYCD9Og4XGn+4xatqDC9vUf8bYV5sBclfFRdX7wuSvpS8od76rp8WOSMR5eJmWI4/
         ZLX7ZrDEQfF/UlY0fg+IyMuMufhBZga5K8nQ2EB8RxN/AoxJgwGGP6q0IaN+UWTcY67H
         g6QD47lW1vSBeqlbPlmmbVk8BLUy9/6xmHOlvDv8yt3U5vj0fEGjWB/2QmGFzJGb1wWu
         +VBto7XKmYc8YkoBYyV5irS+jjMVX6VIhVM55pLjIp/AaoRndad3cTUwXlNPEEywnwZb
         XK+Q==
Original-Received: by 10.152.112.233 with SMTP id it9mr13710957lab.40.1343717231601;
        Mon, 30 Jul 2012 23:47:11 -0700 (PDT)
Original-Received: from localhost (cs78217178.pp.htv.fi. [62.78.217.178])
        by mx.google.com with ESMTPS id n7sm2600404lbk.10.2012.07.30.23.47.09
        (version=TLSv1/SSLv3 cipher=OTHER);
        Mon, 30 Jul 2012 23:47:10 -0700 (PDT)
Content-Disposition: inline
In-Reply-To: <87fw89gf4w.fsf@ti.com>
User-Agent: Mutt/1.5.21 (2010-09-15)
X-Gm-Message-State: ALoCoQmmPT/VHZustsjqvv1ySfg3eCul3f09rd1GUnLc28Gdk7k6zPRuZ2VKBsMBXzoGwNfFgcgJ
Original-Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
Xref: news.gmane.org gmane.linux.kernel:1335520 gmane.linux.ports.arm.omap:81559
Archived-At: <http://permalink.gmane.org/gmane.linux.kernel/1335520>


--d9ADC0YsG2v16Js0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
Content-Transfer-Encoding: quoted-printable

Hi,

On Mon, Jul 30, 2012 at 01:36:47PM -0700, Kevin Hilman wrote:

<little trimming>

> >>> The device tree data for acquiring the above GPIO interrupt line looks
> >>> like this.
> >>>
> >>> +++ linux-omap-storage/arch/arm/boot/dts/omap5-evm.dts  2012-07-30
> >>> 14:11:08.931694001 +0530
> >>> @@ -42,7 +42,8 @@
> >>>         tsl2771@39 {
> >>>                 compatible =3D "taos,tsl2771";
> >>>                 reg =3D <0x39>;
> >>> +                interrupt-parent =3D <&gpio5>;
> >>> +                interrupts =3D <21>; /* gpio line 149 */
> >>>         };
> >>>  };
> >>>
> >>> Note: using "gpio_request_one" in the driver solves the issue.
> >>> Is using this api in the driver required?
> >>> Any pointer on the above crash?
> >>
> > Hi Tarun,
> >> Any user/client driver of GPIO is supposed to go through
> >> gpio_request() API so that module clock
> >> is enabled correctly. Overriding of APIs would put the power
> >> management state machine in jeopardy.
> >> --
> > I tried putting "pm_runtime_get_sync" in gpio_irq_type api where the ke=
rnel
> > is crashing and the crash is no longer observed. So indeed, its about
> > enabling clocks.
> >
> > One doubt: Can't we put runtime apis in "gpio_irq_type" and eliminate
> > the use of
> > "gpio_request_one"??
>=20
> No.
>=20
> You must use the GPIO requiest/free APIs to tell the GPIO core that
> the GPIO line is in use.
>=20
> Why do you want to avoid using gpio_request/gpio_free?

Then how do we differentiate from a driver perspective if e.g.
client->irq (for I2C client drivers) refers to a pin on a GPIO
controller or a real interrupt when running with DT ?

Having something like:

#interrupt-parent =3D &<gpio5>;
interrupts =3D <21>;

would already give me the correct IRQ number from the driver, now how do
we differentiate the interrupt parents ? There's no way to do that from
a driver perspective, so DT core has to either do it, or provide means
for drivers to detect it themselves.

--=20
balbi

--d9ADC0YsG2v16Js0
Content-Type: application/pgp-signature; name="signature.asc"
Content-Description: Digital signature

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.12 (GNU/Linux)

iQIcBAEBAgAGBQJQF36mAAoJEIaOsuA1yqREgBIP/2rbS9fWN3llwkxNhT43ynef
tijg2r1FMIXqXPrQiBjnyI9ISbhEcN9LBTtU8YQrwYPwyNVK2p2xdLii+2DTUfi8
QrSeyKUgsAI7tIQjy477DeLfM3UQNemoSY0EBjX8DrckoftmLPc1zqtNDNlQbBoy
H6uRjoSCszqrn37GgXUhj1+9rJHsKxoOiphTuFphtFIeUJcnJ9IF3gjYlcFA3FgB
fYqArK+qWrrkeJfeVnm0jox4RS6bvhbANSqsz4jJERu1lBS0zaPdAXnt7PdzGry+
2GAo+TfpSVcI58oz0D/m6VHLpvtawv66+MZTEbMJG7LWVlg/gf1CnBwWGLhAi1Jt
n97z+g7HuBiZ5Q/jXjFNTsSo0A8XIXFTpzsRg7PXX5riC5yzc+opwGhEjMJ+KbLL
D2f4GfMCDFpyNNJ0PSAZWdPliMx7iryEuOBFSGXfuwWVCkZPvPIET0c+k+6NTxH5
VFBobrLkTSApaTfqWBcC/sOS8kclO73ZkyPUtDyCqXNKQ71xrWkjvnqywMP4Zaaz
TZmZzQa7p2ORyjzHXbC5Zd6fQWy1ms9AwTmZfugkkHNHM/Y1itqT8PGtDzdRuBLT
sttCiE2pjR9F8XEOynYXcvAArEOyYHjgy1+bU7F2U/HWp6BbO9zuiPPAh2B+XTNx
9uqD3Xumgq7tw73wBjTT
=1Y3c
-----END PGP SIGNATURE-----

--d9ADC0YsG2v16Js0--
